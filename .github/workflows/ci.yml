name: CI/CD Pipeline - Backend

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'Backend/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'Backend/**'
      - '.github/workflows/ci.yml'

env:
  PYTHON_VERSION: "3.12"

jobs:
  # Run linting checks
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "Backend/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check code formatting with Black
        run: black --check --diff app/ tests/

      - name: Check imports with isort
        run: isort --check-only --diff app/ tests/

      - name: Lint with flake8
        run: flake8 app/ tests/

      - name: Type check with mypy
        run: mypy app/ tasks.py

  # Run unit tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: pricewatch
          POSTGRES_PASSWORD: pricewatch
          POSTGRES_DB: pricewatch_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: ./Backend

    env:
      DATABASE_URL: postgresql://pricewatch:pricewatch@localhost:5432/pricewatch_test
      REDIS_URL: redis://localhost:6379/0
      SECRET_KEY: test-secret-key-for-ci-pipeline-only
      SMTP_HOST: smtp.test.com
      SMTP_PORT: 587
      SMTP_USER: test@test.com
      SMTP_PASSWORD: test-password
      EMAIL_FROM: test@pricewatch.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "Backend/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Run unit tests with coverage
        run: |
          python -m pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -m unit \
            --tb=short

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: Backend/htmlcov/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: github.event_name == 'push'
        with:
          file: ./Backend/coverage.xml
          flags: unittests
          name: pricewatch-coverage
          fail_ci_if_error: false

  # Build and test Docker image
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile
          push: false
          tags: pricewatch-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: ./Backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: "Backend/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Check for security vulnerabilities in dependencies
        run: safety check -r requirements.txt --output text || true
        continue-on-error: true

      - name: Run Bandit security linter
        run: bandit -r app/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: Backend/bandit-report.json
          retention-days: 30

  # Integration tests (optional, runs on main branch only)
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > Backend/.env << EOF
          DATABASE_URL=postgresql://pricewatch:pricewatch@db:5432/pricewatch
          REDIS_URL=redis://redis:6379/0
          SECRET_KEY=test-secret-key-for-integration-tests
          SMTP_HOST=smtp.test.com
          SMTP_PORT=587
          SMTP_USER=test@test.com
          SMTP_PASSWORD=test-password
          EMAIL_FROM=test@pricewatch.com
          EOF

      - name: Start services with Docker Compose
        working-directory: ./Backend
        run: |
          docker compose up -d db redis backend
          sleep 10  # Wait for services to be ready

      - name: Check service health
        run: |
          curl -f http://localhost:8000/health || exit 1

      - name: Run integration tests
        working-directory: ./Backend
        run: |
          docker compose exec -T backend python -m pytest tests/test_api.py tests/test_security.py -v --tb=short
        continue-on-error: true

      - name: Collect logs on failure
        if: failure()
        working-directory: ./Backend
        run: docker compose logs

      - name: Cleanup
        if: always()
        working-directory: ./Backend
        run: docker compose down -v

  # Deploy to VPS
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [lint, test, docker-build, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 2222 }}
          script: |
            echo "ðŸš€ Starting deployment on VPS..."

            # Navigate to project directory
            cd /apps/PriceWatch || exit 1

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from master..."
            git pull origin master

            # Navigate to apps directory for docker-compose
            cd /apps

            # Rebuild and restart services
            echo "ðŸ”¨ Building Docker images..."
            docker compose build pricewatch-backend pricewatch-frontend pricewatch-celery-worker pricewatch-celery-beat

            echo "â™»ï¸ Restarting services..."
            docker compose up -d pricewatch-backend pricewatch-celery-worker pricewatch-celery-beat pricewatch-frontend

            # Wait for services to start
            sleep 5

            # Health check
            echo "ðŸ¥ Running health check..."
            curl -f http://10.0.0.1:8000/health || echo "âš ï¸ Backend health check failed"

            echo "âœ… Deployment completed!"

            # Show running containers
            docker ps | grep pricewatch

      - name: Deployment notification
        if: always()
        run: |
          echo "ðŸ“Š Deployment Summary"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
